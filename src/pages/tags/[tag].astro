---
import { Picture } from 'astro:assets';
import defaultImage from '../../assets/images/default.jpg';

export interface Props {
  name: string;
  picture: string; // e.g. 'fraser.jpg'
  excerpt: string;
  company: string;
  linkedin: URL;
  relationship: 'manager' | 'managed' | 'peer';
  readMoreLabel?: string;
}

const {
  name,
  picture,
  excerpt,
  company,
  linkedin,
  relationship,
  readMoreLabel = 'Read more',
} = Astro.props;

// Import all testimony images at build time
const imageMap = import.meta.glob('../../assets/images/testimony/*', { eager: true });

// Helper to resolve the image path or return null
const resolveImage = (filename: string) => {
  const path = `../../assets/images/testimony/${filename}`;
  return filename && imageMap[path] ? imageMap[path].default : null;
};

// Use resolved image or fallback to default
const imagePath = resolveImage(picture) || defaultImage;

// Relationship text
const relationshipText =
  relationship === 'manager'
    ? 'Was my manager'
    : relationship === 'peer'
    ? 'Was my peer'
    : 'Was one of my direct reports';
---

<article class="card">
  <header>
    <h3 class="name">{name}</h3>
    <p class="meta">
      {relationshipText} at <strong>{company}</strong> ·{' '}
      <a href={String(linkedin)} target="_blank" rel="noopener noreferrer">LinkedIn</a>
    </p>
  </header>

  <figure>
    <img src={imagePath} alt={`Portrait of ${name}`} loading="lazy" width="96" height="96" />
    <figcaption class="sr-only">{name} — {company}</figcaption>
  </figure>

  <p class="excerpt">{excerpt}</p>

  <details>
    <summary>
      <button type="button" aria-label={`Read more about ${name}`}>{readMoreLabel}</button>
    </summary>
    <div class="more">
      <slot />
    </div>
  </details>
</article>

<style>
  .card { display: grid; gap: 0.75rem; padding: 1rem; border: 1px solid var(--surface-3, #e5e7eb); border-radius: 0.75rem; }
  header .name { margin: 0; font-size: 1.125rem; }
  .meta { margin: 0; color: var(--text-dim, #6b7280); }
  figure { margin: 0; }
  img { width: 96px; height: 96px; object-fit: cover; border-radius: 9999px; }
  .excerpt { margin: 0.25rem 0 0.25rem; }
  details > summary { list-style: none; }
  details > summary::-webkit-details-marker { display: none; }
  summary button { cursor: pointer; }
  .more { margin-top: 0.5rem; }
</style>
